{% extends "base.html" %}

{% block title %}Projects - GenAI Metrics{% endblock %}

{% block content %}
<div class="main-content">
    <div class="content-header">
        <h1>Projects</h1>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="createProject()">
                <i class="fas fa-plus"></i> New Project
            </button>
        </div>
    </div>

    <div class="content-body">
        <!-- Projects Table -->
        <div class="card">
            <div class="card-header">
                <h3>All Projects</h3>
                <div class="card-actions">
                    <button class="btn btn-sm btn-outline" onclick="refreshProjects()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table" id="projectsTable">
                        <thead>
                            <tr>
                                <th>Project ID</th>
                                <th>Name</th>
                                <th>Status</th>
                                <th>Priority</th>
                                <th>Progress</th>
                                <th>Manager</th>
                                <th>Due Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="projectsTableBody">
                            <tr>
                                <td colspan="8" class="text-center">
                                    <div class="loading-spinner">
                                        <i class="fas fa-spinner fa-spin"></i>
                                        Loading projects...
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Projects management JavaScript
let projectsData = [];

// Load projects data
async function loadProjects() {
    try {
        const response = await fetch('/api/v1/projects/');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        projectsData = await response.json();
        renderProjectsTable();
    } catch (error) {
        console.error('Error loading projects:', error);
        showError('Failed to load projects: ' + error.message);
    }
}

// Render projects table
function renderProjectsTable() {
    const tbody = document.getElementById('projectsTableBody');
    
    if (projectsData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-muted">
                    No projects found
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = projectsData.map(project => `
        <tr>
            <td><code>${project.project_id || 'N/A'}</code></td>
            <td>
                <div class="project-name">
                    <strong>${project.name || 'Unnamed Project'}</strong>
                    ${project.description ? `<br><small class="text-muted">${project.description.substring(0, 100)}${project.description.length > 100 ? '...' : ''}</small>` : ''}
                </div>
            </td>
            <td>
                <span class="badge badge-${getStatusClass(project.status?.name || 'Unknown')}">
                    ${project.status?.name || 'Unknown'}
                </span>
            </td>
            <td>
                <span class="badge badge-${getPriorityClass(project.priority?.name || 'Unknown')}">
                    ${project.priority?.name || 'Unknown'}
                </span>
            </td>
            <td>
                <div class="progress-container">
                    <div class="progress">
                        <div class="progress-bar" style="width: ${project.percent_complete || 0}%"></div>
                    </div>
                    <span class="progress-text">${project.percent_complete || 0}%</span>
                </div>
            </td>
            <td>${project.project_manager || 'N/A'}</td>
            <td>${project.due_date ? new Date(project.due_date).toLocaleDateString() : 'N/A'}</td>
            <td>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline" onclick="viewProject(${project.id})">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline" onclick="editProject(${project.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

// Get status CSS class
function getStatusClass(status) {
    const statusMap = {
        'Active': 'success',
        'Completed': 'info',
        'At Risk': 'warning',
        'Off Track': 'danger'
    };
    return statusMap[status] || 'secondary';
}

// Get priority CSS class
function getPriorityClass(priority) {
    const priorityMap = {
        'Critical': 'danger',
        'High': 'warning',
        'Medium': 'info',
        'Low': 'success'
    };
    return priorityMap[priority] || 'secondary';
}

// View project details
function viewProject(projectId) {
    window.location.href = `/projects/${projectId}`;
}

// Edit project
function editProject(projectId) {
    // TODO: Implement edit functionality
    alert('Edit project functionality coming soon!');
}

// Create new project
function createProject() {
    // TODO: Implement create functionality
    alert('Create project functionality coming soon!');
}

// Refresh projects
function refreshProjects() {
    loadProjects();
}

// Show error message
function showError(message) {
    const tbody = document.getElementById('projectsTableBody');
    tbody.innerHTML = `
        <tr>
            <td colspan="8" class="text-center text-danger">
                <i class="fas fa-exclamation-triangle"></i>
                ${message}
            </td>
        </tr>
    `;
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadProjects();
});
</script>
{% endblock %}
