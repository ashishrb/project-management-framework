{% extends "base.html" %}

{% block title %}Resource Management{% endblock %}

{% block page_title %}Resource Management{% endblock %}

{% block page_actions %}
<div class="btn-group" role="group">
    <button type="button" class="btn btn-primary" onclick="addResource()">
        <i class="fas fa-plus me-1"></i>Add Resource
    </button>
    <button type="button" class="btn btn-outline-primary" onclick="importResources()">
        <i class="fas fa-upload me-1"></i>Import
    </button>
    <button type="button" class="btn btn-outline-secondary" onclick="exportResources()">
        <i class="fas fa-download me-1"></i>Export
    </button>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Resource List -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <div class="row align-items-center">
                    <div class="col">
                        <h5 class="mb-0">Resources</h5>
                    </div>
                    <div class="col-auto">
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control search-input" placeholder="Search resources...">
                            <button class="btn btn-outline-secondary" type="button">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Filters -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <select class="form-select filter-select" data-filter="role">
                            <option value="all">All Roles</option>
                            <option value="developer">Developer</option>
                            <option value="manager">Manager</option>
                            <option value="analyst">Analyst</option>
                            <option value="designer">Designer</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select filter-select" data-filter="experience">
                            <option value="all">All Experience</option>
                            <option value="junior">Junior</option>
                            <option value="mid">Mid-level</option>
                            <option value="senior">Senior</option>
                            <option value="lead">Lead</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select filter-select" data-filter="availability">
                            <option value="all">All Availability</option>
                            <option value="available">Available</option>
                            <option value="busy">Busy</option>
                            <option value="overallocated">Overallocated</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                            <i class="fas fa-times me-1"></i>Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Resource Table -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Resource</th>
                                <th>Role</th>
                                <th>Experience</th>
                                <th>Availability</th>
                                <th>Projects</th>
                                <th>Utilization</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="resources-table">
                            <!-- Resources will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <nav aria-label="Resource pagination">
                    <ul class="pagination justify-content-center" id="resources-pagination">
                        <!-- Pagination will be loaded here -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Resource Analytics -->
    <div class="col-lg-4">
        <!-- Resource Overview -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">Resource Overview</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="metric-value text-primary" id="total-resources">0</div>
                        <div class="metric-label">Total Resources</div>
                    </div>
                    <div class="col-6">
                        <div class="metric-value text-success" id="available-resources">0</div>
                        <div class="metric-label">Available</div>
                    </div>
                </div>
                <hr>
                <div class="row text-center">
                    <div class="col-6">
                        <div class="metric-value text-warning" id="busy-resources">0</div>
                        <div class="metric-label">Busy</div>
                    </div>
                    <div class="col-6">
                        <div class="metric-value text-danger" id="overallocated-resources">0</div>
                        <div class="metric-label">Overallocated</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Utilization Chart -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">Resource Utilization</h6>
            </div>
            <div class="card-body">
                <canvas id="utilizationChart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Skills Distribution -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">Skills Distribution</h6>
            </div>
            <div class="card-body">
                <canvas id="skillsChart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Recent Allocations -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Recent Allocations</h6>
            </div>
            <div class="card-body">
                <div id="recent-allocations">
                    <!-- Recent allocations will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Resource Detail Modal -->
<div class="modal fade" id="resourceDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Resource Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="resource-detail-content">
                    <!-- Resource details will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Resource Modal -->
<div class="modal fade" id="addResourceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Resource</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addResourceForm">
                    <div class="mb-3">
                        <label for="resourceName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="resourceName" required>
                    </div>
                    <div class="mb-3">
                        <label for="resourceEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="resourceEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="resourceRole" class="form-label">Role</label>
                        <select class="form-select" id="resourceRole" required>
                            <option value="">Select Role</option>
                            <option value="developer">Developer</option>
                            <option value="manager">Manager</option>
                            <option value="analyst">Analyst</option>
                            <option value="designer">Designer</option>
                            <option value="tester">Tester</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="resourceExperience" class="form-label">Experience Level</label>
                        <select class="form-select" id="resourceExperience" required>
                            <option value="">Select Experience</option>
                            <option value="junior">Junior</option>
                            <option value="mid">Mid-level</option>
                            <option value="senior">Senior</option>
                            <option value="lead">Lead</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="resourceSkills" class="form-label">Skills</label>
                        <input type="text" class="form-control" id="resourceSkills" placeholder="Enter skills separated by commas">
                    </div>
                    <div class="mb-3">
                        <label for="resourceAvailability" class="form-label">Availability (%)</label>
                        <input type="number" class="form-control" id="resourceAvailability" min="0" max="100" value="100">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveResource()">Save Resource</button>
            </div>
        </div>
    </div>
</div>

<!-- Allocation Modal -->
<div class="modal fade" id="allocationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Allocate Resource</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="allocationForm">
                    <div class="mb-3">
                        <label for="allocationProject" class="form-label">Project</label>
                        <select class="form-select" id="allocationProject" required>
                            <option value="">Select Project</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="allocationPercentage" class="form-label">Allocation Percentage</label>
                        <input type="number" class="form-control" id="allocationPercentage" min="1" max="100" required>
                    </div>
                    <div class="mb-3">
                        <label for="allocationRole" class="form-label">Role in Project</label>
                        <input type="text" class="form-control" id="allocationRole" placeholder="e.g., Team Member, Lead Developer">
                    </div>
                    <div class="mb-3">
                        <label for="allocationStartDate" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="allocationStartDate">
                    </div>
                    <div class="mb-3">
                        <label for="allocationEndDate" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="allocationEndDate">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveAllocation()">Save Allocation</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Resource management page JavaScript
let currentResourceId = null;
let utilizationChart = null;
let skillsChart = null;

document.addEventListener('DOMContentLoaded', function() {
    loadResources();
    loadResourceAnalytics();
    loadRecentAllocations();
    initializeCharts();
});

// Load resources
async function loadResources() {
    try {
        const data = await GenAIDashboard.apiCall('/resources/');
        renderResources(data);
        updateResourceOverview(data);
    } catch (error) {
        console.error('Error loading resources:', error);
        GenAIDashboard.showError('Failed to load resources');
    }
}

// Render resources table
function renderResources(resources) {
    const container = document.getElementById('resources-table');
    if (!container) return;
    
    if (resources.length === 0) {
        container.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No resources found</td></tr>';
        return;
    }
    
    const html = resources.map(resource => `
        <tr class="filterable-item" data-filter-value="${resource.role}">
            <td>
                <div class="d-flex align-items-center">
                    <div class="resource-avatar me-2">${resource.name.charAt(0).toUpperCase()}</div>
                    <div>
                        <h6 class="mb-0">${resource.name}</h6>
                        <small class="text-muted">${resource.email}</small>
                    </div>
                </div>
            </td>
            <td>
                <span class="badge bg-secondary">${resource.role || 'N/A'}</span>
            </td>
            <td>
                <span class="badge bg-info">${resource.experience_level || 'N/A'}</span>
            </td>
            <td>
                <div class="d-flex align-items-center">
                    <div class="progress me-2" style="width: 60px; height: 8px;">
                        <div class="progress-bar bg-${getAvailabilityColor(resource.availability_percentage)}" 
                             style="width: ${resource.availability_percentage || 0}%"></div>
                    </div>
                    <small>${resource.availability_percentage || 0}%</small>
                </div>
            </td>
            <td>
                <span class="badge bg-primary">${resource.project_count || 0}</span>
            </td>
            <td>
                <div class="d-flex align-items-center">
                    <div class="progress me-2" style="width: 60px; height: 8px;">
                        <div class="progress-bar bg-${getUtilizationColor(resource.utilization_rate)}" 
                             style="width: ${resource.utilization_rate || 0}%"></div>
                    </div>
                    <small>${Math.round(resource.utilization_rate || 0)}%</small>
                </div>
            </td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="viewResource(${resource.id})" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-outline-success" onclick="allocateResource(${resource.id})" title="Allocate">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="btn btn-outline-warning" onclick="editResource(${resource.id})" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteResource(${resource.id})" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
    
    container.innerHTML = html;
}

// Get availability color
function getAvailabilityColor(percentage) {
    if (percentage >= 80) return 'success';
    if (percentage >= 50) return 'warning';
    return 'danger';
}

// Get utilization color
function getUtilizationColor(percentage) {
    if (percentage <= 80) return 'success';
    if (percentage <= 100) return 'warning';
    return 'danger';
}

// Update resource overview
function updateResourceOverview(resources) {
    const total = resources.length;
    const available = resources.filter(r => (r.availability_percentage || 0) >= 80).length;
    const busy = resources.filter(r => (r.availability_percentage || 0) < 80 && (r.availability_percentage || 0) >= 50).length;
    const overallocated = resources.filter(r => (r.availability_percentage || 0) < 50).length;
    
    document.getElementById('total-resources').textContent = total;
    document.getElementById('available-resources').textContent = available;
    document.getElementById('busy-resources').textContent = busy;
    document.getElementById('overallocated-resources').textContent = overallocated;
}

// Load resource analytics
async function loadResourceAnalytics() {
    try {
        const [availabilityData, workloadData] = await Promise.all([
            GenAIDashboard.apiCall('/resources/analytics/availability'),
            GenAIDashboard.apiCall('/resources/analytics/workload')
        ]);
        
        updateUtilizationChart(workloadData);
        updateSkillsChart(availabilityData);
    } catch (error) {
        console.error('Error loading resource analytics:', error);
    }
}

// Update utilization chart
function updateUtilizationChart(data) {
    const ctx = document.getElementById('utilizationChart').getContext('2d');
    
    if (utilizationChart) {
        utilizationChart.destroy();
    }
    
    const labels = data.map(r => r.resource_name);
    const utilization = data.map(r => Math.round(r.utilization_rate || 0));
    
    utilizationChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Utilization %',
                data: utilization,
                backgroundColor: utilization.map(u => 
                    u <= 80 ? '#28a745' : u <= 100 ? '#ffc107' : '#dc3545'
                ),
                borderColor: utilization.map(u => 
                    u <= 80 ? '#1e7e34' : u <= 100 ? '#e0a800' : '#bd2130'
                ),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 120
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

// Update skills chart
function updateSkillsChart(data) {
    const ctx = document.getElementById('skillsChart').getContext('2d');
    
    if (skillsChart) {
        skillsChart.destroy();
    }
    
    // Count skills
    const skillCounts = {};
    data.forEach(resource => {
        if (resource.skills) {
            resource.skills.forEach(skill => {
                skillCounts[skill] = (skillCounts[skill] || 0) + 1;
            });
        }
    });
    
    const skills = Object.keys(skillCounts).slice(0, 10); // Top 10 skills
    const counts = skills.map(skill => skillCounts[skill]);
    
    skillsChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: skills,
            datasets: [{
                data: counts,
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                    '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// Load recent allocations
async function loadRecentAllocations() {
    try {
        const data = await GenAIDashboard.apiCall('/resources/analytics/allocations');
        renderRecentAllocations(data);
    } catch (error) {
        console.error('Error loading recent allocations:', error);
    }
}

// Render recent allocations
function renderRecentAllocations(allocations) {
    const container = document.getElementById('recent-allocations');
    if (!container) return;
    
    if (allocations.length === 0) {
        container.innerHTML = '<p class="text-muted">No recent allocations</p>';
        return;
    }
    
    const html = allocations.slice(0, 5).map(allocation => `
        <div class="d-flex align-items-start mb-2">
            <div class="flex-shrink-0">
                <i class="fas fa-user-plus text-primary"></i>
            </div>
            <div class="flex-grow-1 ms-2">
                <h6 class="mb-0 small">${allocation.resource_name}</h6>
                <small class="text-muted">Allocated to ${allocation.project_name}</small>
                <div class="small text-muted">${allocation.allocation_percentage}% - ${allocation.role}</div>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = html;
}

// Initialize charts
function initializeCharts() {
    // Charts will be initialized when data is loaded
}

// Action functions
function addResource() {
    const modal = new bootstrap.Modal(document.getElementById('addResourceModal'));
    modal.show();
}

function saveResource() {
    const form = document.getElementById('addResourceForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    // Process skills
    if (data.resourceSkills) {
        data.skills = data.resourceSkills.split(',').map(s => s.trim()).filter(s => s);
    }
    
    // Remove the original skills field
    delete data.resourceSkills;
    
    // Submit resource
    GenAIDashboard.apiCall('/resources/', 'POST', data)
        .then(() => {
            GenAIDashboard.showSuccess('Resource added successfully');
            bootstrap.Modal.getInstance(document.getElementById('addResourceModal')).hide();
            form.reset();
            loadResources();
        })
        .catch(error => {
            GenAIDashboard.showError('Failed to add resource');
        });
}

function viewResource(resourceId) {
    currentResourceId = resourceId;
    const modal = new bootstrap.Modal(document.getElementById('resourceDetailModal'));
    modal.show();
    
    // Load resource details
    loadResourceDetails(resourceId);
}

function loadResourceDetails(resourceId) {
    GenAIDashboard.apiCall(`/resources/${resourceId}`)
        .then(data => {
            renderResourceDetails(data);
        })
        .catch(error => {
            GenAIDashboard.showError('Failed to load resource details');
        });
}

function renderResourceDetails(resource) {
    const container = document.getElementById('resource-detail-content');
    container.innerHTML = `
        <div class="row">
            <div class="col-md-4">
                <div class="text-center">
                    <div class="resource-avatar mx-auto mb-3" style="width: 80px; height: 80px; font-size: 2rem;">
                        ${resource.name.charAt(0).toUpperCase()}
                    </div>
                    <h5>${resource.name}</h5>
                    <p class="text-muted">${resource.email}</p>
                </div>
            </div>
            <div class="col-md-8">
                <h6>Details</h6>
                <table class="table table-sm">
                    <tr>
                        <td><strong>Role:</strong></td>
                        <td>${resource.role || 'N/A'}</td>
                    </tr>
                    <tr>
                        <td><strong>Experience:</strong></td>
                        <td>${resource.experience_level || 'N/A'}</td>
                    </tr>
                    <tr>
                        <td><strong>Availability:</strong></td>
                        <td>${resource.availability_percentage || 0}%</td>
                    </tr>
                    <tr>
                        <td><strong>Skills:</strong></td>
                        <td>${(resource.skills || []).join(', ') || 'N/A'}</td>
                    </tr>
                </table>
            </div>
        </div>
    `;
}

function allocateResource(resourceId) {
    currentResourceId = resourceId;
    const modal = new bootstrap.Modal(document.getElementById('allocationModal'));
    modal.show();
    
    // Load projects for allocation
    loadProjectsForAllocation();
}

function loadProjectsForAllocation() {
    GenAIDashboard.apiCall('/projects/')
        .then(projects => {
            const select = document.getElementById('allocationProject');
            select.innerHTML = '<option value="">Select Project</option>' +
                projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        })
        .catch(error => {
            console.error('Error loading projects:', error);
        });
}

function saveAllocation() {
    const form = document.getElementById('allocationForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    if (!currentResourceId) return;
    
    GenAIDashboard.apiCall(`/resources/${currentResourceId}/projects/${data.allocationProject}/allocate`, 'POST', {
        allocation_percentage: parseInt(data.allocationPercentage),
        role_in_project: data.allocationRole
    })
    .then(() => {
        GenAIDashboard.showSuccess('Resource allocated successfully');
        bootstrap.Modal.getInstance(document.getElementById('allocationModal')).hide();
        form.reset();
        loadResources();
    })
    .catch(error => {
        GenAIDashboard.showError('Failed to allocate resource');
    });
}

function editResource(resourceId) {
    // Implement edit resource functionality
    console.log('Edit resource:', resourceId);
}

function deleteResource(resourceId) {
    if (confirm('Are you sure you want to delete this resource?')) {
        GenAIDashboard.apiCall(`/resources/${resourceId}`, 'DELETE')
            .then(() => {
                GenAIDashboard.showSuccess('Resource deleted successfully');
                loadResources();
            })
            .catch(error => {
                GenAIDashboard.showError('Failed to delete resource');
            });
    }
}

function importResources() {
    // Implement import resources functionality
    console.log('Import resources');
}

function exportResources() {
    // Implement export resources functionality
    console.log('Export resources');
}

function clearFilters() {
    document.querySelectorAll('.filter-select').forEach(select => {
        select.value = 'all';
    });
    
    document.querySelectorAll('.filterable-item').forEach(item => {
        item.style.display = '';
    });
}
</script>
{% endblock %}
